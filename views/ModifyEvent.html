<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키우미 | 일정 수정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'main-red': '#ed2024', 'sub-blue': '#003875' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .app-container { min-height: 100vh; display: flex; flex-direction: column; }
        .section-card { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .event-tab { padding: 0.75rem 1rem; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transform: translateY(1px); cursor: pointer; }
        .event-tab.active-tab { color: #003875; border-bottom-color: #003875; }
    </style>
</head>

<body>

    <div class="app-container">

        <header class="flex justify-between items-center px-4 py-4 flex-shrink-0 bg-white shadow-sm">
            <a id="cancel-link" href="/Calendar" class="p-2 rounded-full hover:bg-slate-200 transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </a>
            <h1 class="text-xl font-bold text-slate-800 flex-grow text-center pr-12">일정 수정</h1>
        </header>

        <main class="flex-grow px-4 py-4 overflow-y-auto pb-20">
            <div id="modify-event-section" class="section-card p-4 rounded-lg shadow-md mb-8 h-full min-h-[600px]">
                
                {% if user_role == 'admin' %}
                    <div class="border-b border-slate-200 mb-4">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button id="tab-public" type="button" class="event-tab active-tab">학사 일정</button>
                            <button id="tab-private" type="button" class="event-tab">개인 일정</button>
                        </nav>
                    </div>
                    <p id="personal-desc" class="text-slate-600 mb-4 text-sm sm:text-base hidden">개인적인 스케줄을 달력에 등록하고 관리하세요.</p>
                {% else %}
                    <h3 id="sub-title" class="text-lg font-bold mb-3">개인 일정 수정</h3>
                    <p class="text-slate-600 mb-4 text-sm sm:text-base">일정 내용을 수정합니다.</p>
                {% endif %}
                
                <div class="bg-slate-100 p-3 rounded-lg flex flex-col h-[80%]">
                    <form id="modify-event-form" method="post" class="flex flex-col h-full p-2 space-y-4">
                        
                        <input type="hidden" id="event-type" name="event_type" 
                               value="{% if user_role == 'admin' %}public{% else %}private{% endif %}">
                        
                        <div>
                            <label for="event-title" class="block text-sm font-medium text-slate-700">일정명</label>
                            <input type="text" id="event-title" name="title" placeholder="예: 팀 프로젝트 회의"
                                class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                        </div>

                        <div id="public-fields" class="grid grid-cols-2 gap-4 hidden">
                            <div>
                                <label for="start-date" class="block text-sm font-medium text-slate-700">시작일</label>
                                <input type="date" id="start-date" name="start_date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-medium text-slate-700">종료일</label>
                                <input type="date" id="end-date" name="end_date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                            </div>
                        </div>

                        <div id="personal-fields" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="event-date" class="block text-sm font-medium text-slate-700">날짜</label>
                                    <input type="date" id="event-date" name="event_date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="event-time" class="block text-sm font-medium text-slate-700">시간 (선택)</label>
                                    <input type="time" id="event-time" name="event_time" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">배경색</label>
                                <div id="event-color-options" class="mt-2 flex space-x-3">
                                    <div data-color="bg-red-200" class="event-color-option w-8 h-8 rounded-full bg-red-200 cursor-pointer"></div>
                                    <div data-color="bg-blue-200" class="event-color-option w-8 h-8 rounded-full bg-blue-200 cursor-pointer"></div>
                                    <div data-color="bg-yellow-200" class="event-color-option w-8 h-8 rounded-full bg-yellow-200 cursor-pointer"></div>
                                </div>
                                <input type="hidden" name="event_color" id="event-color" value="bg-red-200" />
                            </div>
                            <div>
                                <label for="event-memo" class="block text-sm font-medium text-slate-700">메모 (선택)</label>
                                <textarea id="event-memo" name="memo" rows="3" placeholder="메모를 입력하세요"
                                    class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm"></textarea>
                            </div>
                        </div>
                        
                        <div class="mt-auto pt-4">
                            <button type="submit" id="submit-button"
                                class="w-full bg-main-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors">수정 완료</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
        
        </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function () {
        
        // --- 1. 폼 요소 및 URL 정보 가져오기 ---
        const params = new URLSearchParams(window.location.search);
    const eventId = params.get('eventId');
    const urlType = (params.get('type') || 'personal');
        
        const form = document.getElementById('modify-event-form');
    const eventColorOptions = document.getElementById('event-color-options');
        const eventColorHidden = document.getElementById('event-color');
    const memoInput = document.getElementById('event-memo');
        
        const tabPublic = document.getElementById('tab-public');
        const tabPrivate = document.getElementById('tab-private');
        const personalDesc = document.getElementById('personal-desc');
        const eventTypeInput = document.getElementById('event-type');
        const submitButton = document.getElementById('submit-button');
        const publicFields = document.getElementById('public-fields');
        const personalFields = document.getElementById('personal-fields');
        const subTitleEl = document.getElementById('sub-title');
        // 서브 타이틀 설정 헬퍼 (학생 전용 섹션에만 존재)
        function setSubTitleByType(type) {
            if (!subTitleEl) return; // 관리자 화면에는 없음
            if (type === 'academic' || type === 'public') {
                subTitleEl.textContent = '학사 일정 수정';
            } else {
                subTitleEl.textContent = '개인 일정 수정';
            }
        }
        
        // 닫기 버튼 링크 설정
    document.getElementById('cancel-link').href = `/ViewEvent?eventId=${eventId}&type=${encodeURIComponent(urlType)}`;

        if (!eventId) {
            alert('수정할 일정 ID가 없습니다.');
            window.location.href = '/Calendar';
            return;
        }

        // --- 2. 탭 전환 로직 (AddEvent.html과 동일) ---
        function setTab(type) {
             if (type === 'public') {
                if(tabPublic) tabPublic.classList.add('active-tab');
                if(tabPrivate) tabPrivate.classList.remove('active-tab');
                eventTypeInput.value = 'public';
                if (personalDesc) personalDesc.classList.add('hidden');
                submitButton.classList.add('bg-main-red', 'hover:bg-red-700');
                submitButton.classList.remove('bg-sub-blue', 'hover:bg-blue-800');
                if (publicFields) publicFields.classList.remove('hidden');
                if (personalFields) personalFields.classList.add('hidden');
             } else {
                if(tabPrivate) tabPrivate.classList.add('active-tab');
                if(tabPublic) tabPublic.classList.remove('active-tab');
                eventTypeInput.value = 'private';
                if (personalDesc) personalDesc.classList.remove('hidden');
                submitButton.classList.add('bg-sub-blue', 'hover:bg-blue-800');
                submitButton.classList.remove('bg-main-red', 'hover:bg-red-700');
                if (publicFields) publicFields.classList.add('hidden');
                if (personalFields) personalFields.classList.remove('hidden');
             }
        }
        
       if (tabPublic && tabPrivate) {
           tabPublic.addEventListener('click', () => { setTab('public'); /* 관리자 화면엔 서브타이틀 없음 */ });
           tabPrivate.addEventListener('click', () => { setTab('private'); /* 관리자 화면엔 서브타이틀 없음 */ });
       }

        // --- 3. (핵심) 기존 데이터 불러와서 폼 채우기 (GET) ---
        try {
            const response = await fetch(`/api/events/${eventId}?type=${encodeURIComponent(urlType)}`); // 타입과 함께 조회
            if (!response.ok) throw new Error('데이터 로딩 실패');
            
            const data = await response.json();
            
            // (백엔드 응답 예시)
            // { 
            //   id: 123, type: 'personal', title: '팀 프로젝트', event_date: '2025-11-10', 
            //   event_time: '15:00', start_date: null, end_date: null, event_color: 'bg-blue-200'
            // }

            // 폼 필드 채우기
            document.getElementById('event-title').value = data.title;
            
            // 탭 설정 및 폼 필드 보이기 (API는 'academic'/'personal'을 반환하므로 UI의 'public'/'private'로 매핑)
            if (data.type === 'academic') {
                setTab('public');
                setSubTitleByType('academic');
            } else {
                setTab('private');
                setSubTitleByType('personal');
            }
            
            if (data.type === 'academic') {
                document.getElementById('start-date').value = data.start_date || '';
                document.getElementById('end-date').value = data.end_date || '';
            } else {
                document.getElementById('event-date').value = data.event_date || '';
                document.getElementById('event-time').value = data.event_time || '';
                if (memoInput) memoInput.value = data.memo || '';
                
                // 색상 선택
                const color = data.color || 'bg-red-200';
                eventColorHidden.value = color;
                const activeColorEl = eventColorOptions.querySelector(`[data-color="${color}"]`);
                if (activeColorEl) {
                    activeColorEl.classList.add('ring-2', 'ring-offset-2', 'ring-sub-blue');
                } // 지원하지 않는 색상(예: 기존 초록)은 선택 표시 없이 유지
            }

        } catch (error) {
            console.error('Error fetching data:', error);
            alert('일정 정보를 불러오는 데 실패했습니다.');
        }

        // --- 4. 색상 선택 로직 (AddEvent.html과 동일) ---
        if (eventColorOptions) {
            eventColorOptions.addEventListener('click', (e) => {
                if (e.target.classList.contains('event-color-option')) {
                    eventColorOptions.querySelectorAll('.event-color-option').forEach(opt => {
                        opt.classList.remove('ring-2', 'ring-offset-2', 'ring-sub-blue');
                    });
                    e.target.classList.add('ring-2', 'ring-offset-2', 'ring-sub-blue');
                    if (eventColorHidden) eventColorHidden.value = e.target.dataset.color || 'bg-red-200';
                }
            });
        }

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const params = new URLSearchParams();
                const titleInput = document.getElementById('event-title').value;
                const eventType = eventTypeInput.value;
                params.set('title', titleInput);
                params.set('event_type', eventType);

                if (eventType === 'public') {
                    const startInput = document.getElementById('start-date').value;
                    const endInput = document.getElementById('end-date').value;
                    if (!titleInput || !startInput || !endInput) {
                        alert('제목과 시작일/종료일은 필수입니다!'); return;
                    }
                    if (new Date(startInput) > new Date(endInput)) {
                        alert('종료일은 시작일보다 빠를 수 없습니다.'); return;
                    }
                    params.set('start_date', startInput);
                    params.set('end_date', endInput);
                } else {
                    const dateInput = document.getElementById('event-date').value;
                    const selectedColorEl = eventColorOptions.querySelector('.ring-sub-blue');
                    if (!titleInput || !dateInput) {
                        alert('제목과 날짜는 필수입니다!'); return;
                    }
                    params.set('event_date', dateInput);
                    params.set('event_time', document.getElementById('event-time').value || '');
                    // 색상: 선택된 게 없으면 기존 색상(hidden)을 유지
                    const chosenColor = selectedColorEl ? (selectedColorEl.dataset.color || 'bg-red-200') : (eventColorHidden.value || 'bg-red-200');
                    params.set('event_color', chosenColor);
                    if (memoInput && memoInput.value) params.set('memo', memoInput.value);
                }

                try {
                    // 현재 탭(이벤트 타입)을 반영하기 위해 쿼리스트링 대신 body의 event_type을 사용
                    const resp = await fetch(`/api/events/${eventId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
                        body: params.toString()
                    });
                    const data = await resp.json();
                    
                    if (data && data.ok) {
                        alert('성공적으로 수정되었습니다!');
                        window.location.href = `/ViewEvent?eventId=${eventId}&type=${encodeURIComponent(urlType)}`; // 수정 후 상세 페이지로 복귀
                    } else {
                        alert(data && data.message ? data.message : '수정 실패');
                    }
                } catch (e) {
                    console.error(e);
                    alert('서버 오류');
                }
            });
        }
    });
</script>
</body>

</html>
