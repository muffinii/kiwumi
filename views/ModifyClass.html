<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키우미 | 수업 수정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'main-red': '#ed2024', 'sub-blue': '#003875' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .app-container { 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        .section-card { 
            background-color: white; padding: 1.5rem; border-radius: 0.5rem; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); 
        }
        
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #475569; }
        
        /* ▼▼▼ [핵심 수정] 드롭다운 스타일링 및 네이티브 UI 제거 ▼▼▼ */
        .form-select {
            width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;
            background-color: #f8fafc; 
            transition: border-color 0.15s ease-in-out;
            
            /* 네이티브 드롭다운 화살표 제거 */
            -webkit-appearance: none; 
            -moz-appearance: none; 
            appearance: none;
            
            /* 커스텀 화살표 아이콘 */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center; /* 오른쪽 패딩 확보 */
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em; /* 아이콘 크기 조정 */
        }
        .form-select:focus { outline: none; border-color: #003875; box-shadow: 0 0 0 1px #003875; }
        .form-select:disabled { background-color: #e2e8f0; color: #94a3b8; }
        
        .form-input {
            width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;
            background-color: #f8fafc;
            transition: border-color 0.15s ease-in-out;
        }
        .form-input:disabled { background-color: #e2e8f0; color: #94a3b8; }
        /* ▲▲▲ 수정 완료 ▲▲▲ */
        
    </style>
</head>
<body>

    <div class="app-container">
        
        <header class="flex justify-between items-center px-4 py-4 flex-shrink-0 bg-white shadow-sm">
            <a id="back-to-view" href="#" class="p-2 rounded-full hover:bg-slate-200 transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </a>
            <h1 class="text-xl font-bold text-slate-800 flex-grow text-center pr-12">수업 수정</h1>
        </header>

        <main class="flex-grow px-4 py-4 overflow-y-auto pb-20">
            
            <form id="modify-form" class="section-card p-6">
                
                <h2 class="text-xl font-bold mb-5">수업 정보</h2>

                <div class="space-y-4 mb-6">
                    <label for="title" class="form-label">과목명</label>
                    <input type="text" id="title" name="title" placeholder="과목 이름" required disabled
                        class="form-input">
                </div>
                <div class="mb-6">
                    <label for="section-select" class="form-label">시간 / 장소 (분반)</label>
                    <select id="section-select" name="section_id" class="form-select" disabled></select>
                </div>
                
                <h3 class="text-lg font-bold mb-3 border-t pt-4 mt-6">표시 설정</h3>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="text-slate-700 block mb-2">과목 색상</label>
                        <input type="hidden" name="class_color" id="class_color" value="bg-blue-100">
                        <div id="colorPalette" class="flex gap-2">
                            <button type="button" data-color="bg-blue-100" class="w-8 h-8 rounded border-2 border-sub-blue bg-blue-100"></button>
                            <button type="button" data-color="bg-red-100" class="w-8 h-8 rounded border bg-red-100"></button>
                            <button type="button" data-color="bg-green-100" class="w-8 h-8 rounded border bg-green-100"></button>
                            <button type="button" data-color="bg-yellow-100" class="w-8 h-8 rounded border bg-yellow-100"></button>
                            <button type="button" data-color="bg-purple-100" class="w-8 h-8 rounded border bg-purple-100"></button>
                            <button type="button" data-color="bg-pink-100" class="w-8 h-8 rounded border bg-pink-100"></button>
                        </div>
                    </div>
                    
                    <div>
                        <label for="memo" class="form-label">메모 (선택)</label>
                        <textarea id="memo" name="memo" placeholder="수업 관련 메모나 특이사항" rows="3"
                            class="form-input"></textarea>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-main-red text-white p-3 rounded-lg font-bold text-lg hover:bg-red-700 transition shadow-lg">
                    수정 완료
                </button>
            </form>

        </main>
        
        <nav class="flex-shrink-0 fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.05)] pt-1">
            <div class="flex justify-around h-16 items-start">
                <a href="/Main" class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span class="text-xs mt-1">홈</span>
                </a>
                <a href="/Calendar" class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>
                    <span class="text-xs mt-1">캘린더</span>
                </a>
                <a href="/AnnouncementGuest" class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13"></path><path d="M8 12h13"></path><path d="M8 18h13"></path><path d="M3 6h.01"></path><path d="M3 12h.01"></path><path d="M3 18h.01"></path></svg>
                    <span class="text-xs mt-1">공지사항</span>
                </a>
                <a href="/Timetable" class="flex flex-col items-center justify-center text-main-red font-bold p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"></rect><rect width="7" height="5" x="14" y="3" rx="1"></rect><rect width="7" height="9" x="14" y="12" rx="1"></rect><rect width="7" height="5" x="3" y="16" rx="1"></rect></svg>
                    <span class="text-xs mt-1">시간표</span>
                </a>
                <a href="/MyPage" class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span class="text-xs mt-1">마이페이지</span>
                </a>
            </div>
        </nav>
        </div>

    <script>
        const colorPalette = document.getElementById('colorPalette');
        const colorHidden = document.getElementById('class_color');
        const form = document.getElementById('modify-form');
        const backToView = document.getElementById('back-to-view');
        const sectionSelect = document.getElementById('section-select');

        let courseIdCache = null; 

        // --- 색상 선택 로직 ---
        function updateColorSelection() {
            const selectedColor = colorHidden.value;
            Array.from(colorPalette.querySelectorAll('button[data-color]')).forEach(b => {
                b.classList.remove('border-2', 'border-sub-blue');
                b.classList.add('border');
                if (b.getAttribute('data-color') === selectedColor) {
                    b.classList.remove('border');
                    b.classList.add('border-2', 'border-sub-blue');
                }
            });
        }
        
        colorPalette.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-color]');
            if (!btn) return;
            const color = btn.getAttribute('data-color');
            colorHidden.value = color;
            updateColorSelection();
        });


        // --- 분반 목록 가져오기 및 현재 상태 표시 ---
        async function fetchAndPopulateSections(currentCourseId, currentSectionId) {
            sectionSelect.innerHTML = '<option value="">분반 정보를 불러오는 중...</option>';
            sectionSelect.disabled = true;

            if (!currentCourseId) {
                sectionSelect.innerHTML = '<option value="">과목 ID가 없습니다.</option>';
                return;
            }

            try {
                // (백엔드) /api/course/{courseId}/sections API를 호출하여 해당 과목의 모든 분반을 가져옵니다.
                const response = await fetch(`/api/course/${currentCourseId}/sections`);
                if (!response.ok) throw new Error('분반 로드 실패');
                
                const sections = await response.json(); 

                sectionSelect.innerHTML = '<option value="">다른 분반을 선택하세요...</option>';
                let foundCurrent = false;

                sections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = `${section.section_number}분반 - ${section.time_string} (${section.place})`;
                    
                    if (section.id === currentSectionId) {
                        option.selected = true; 
                        foundCurrent = true;
                    }
                    sectionSelect.appendChild(option);
                });
                
                if (!foundCurrent) {
                    alert("경고: 기존 분반 정보를 찾을 수 없습니다. 수정이 제한됩니다.");
                    sectionSelect.disabled = true;
                } else {
                    sectionSelect.disabled = false;
                }

            } catch (error) {
                console.error("Error loading sections:", error);
                sectionSelect.innerHTML = '<option value="">분반 로드 중 오류 발생</option>';
            }
        }


        // --- 페이지 로드 (GET) 및 폼 제출 (PUT) 로직 ---
        document.addEventListener('DOMContentLoaded', async function () {
            const params = new URLSearchParams(window.location.search);
            const classId = params.get('classId'); 

            // 뒤로가기 버튼 링크 설정
            backToView.href = `/ViewClass?classId=${classId}`;

            if (!classId) {
                alert('수정할 수업 ID가 없습니다.');
                window.location.href = '/Timetable';
                return;
            }

            try {
                // 1. 기존 시간표 항목의 전체 정보 로드 (모든 시간 슬롯 포함)
                const response = await fetch(`/api/classes/${classId}`);
                if (!response.ok) throw new Error('데이터 로딩 실패');
                const data = await response.json();
                
                // 2. 기본 정보 채우기
                document.getElementById('title').value = data.title || '정보 없음';
                document.getElementById('memo').value = data.memo || '';
                colorHidden.value = data.color || 'bg-blue-100';
                updateColorSelection();

                // 3. 시간표 슬롯을 분반 선택으로 표시
                sectionSelect.innerHTML = '';
                if (data.slots && data.slots.length > 0) {
                    data.slots.forEach((slot, index) => {
                        const option = document.createElement('option');
                        option.value = slot.id;
                        // 장소가 없으면 빈 문자열로 표시
                        const placeText = slot.place && slot.place !== 'null' ? slot.place : '';
                        option.textContent = `${slot.day} ${slot.startTime}-${slot.endTime}${placeText ? ` (${placeText})` : ''}`;
                        if (index === 0) option.selected = true;
                        sectionSelect.appendChild(option);
                    });
                    sectionSelect.disabled = false;
                } else {
                    sectionSelect.innerHTML = '<option value="">시간 정보 없음</option>';
                    sectionSelect.disabled = true;
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                alert('수업 정보를 불러오는 데 실패했습니다.');
            }
        });

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const classId = new URLSearchParams(window.location.search).get('classId');

            const color = colorHidden.value;
            const memo = document.getElementById('memo').value;

            try {
                // 기존 데이터를 다시 가져와서 slots 정보 유지
                const getResponse = await fetch(`/api/classes/${classId}`);
                if (!getResponse.ok) throw new Error('데이터 로딩 실패');
                const currentData = await getResponse.json();

                // 색상과 메모만 업데이트, 나머지는 기존 데이터 유지
                const data = {
                    title: currentData.title,
                    class_color: color,
                    memo: memo,
                    professor: currentData.professor,
                    credits: currentData.credits,
                    slots: currentData.slots
                };

                // 수정 요청 (PUT)
                const response = await fetch(`/api/classes/${classId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (!response.ok || !result.ok) {
                    throw new Error(result.message || '수정 실패');
                }

                alert('수업 정보가 성공적으로 수정되었습니다.');
                // 새로 생성된 첫 번째 슬롯의 ID로 ViewClass 페이지로 이동
                if (result.newClassId) {
                    window.location.href = `/ViewClass?classId=${result.newClassId}`;
                } else {
                    window.location.href = '/Timetable';
                } 

            } catch (error) {
                console.error('Error updating data:', error);
                alert('수정 중 오류가 발생했습니다: ' + error.message);
            }
        });
    </script>
</body>
</html>
