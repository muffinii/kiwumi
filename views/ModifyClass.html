<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키우미 | 시간표 수정/title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
            rel="stylesheet">
        <script>
            // Tailwind configuration and custom colors maintained
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            'main-red': '#ed2024',
                            'sub-blue': '#003875',
                        }
                    }
                }
            }
        </script>
        <style>
            /* 기존 디자인 스타일 유지 */
            body {
                font-family: 'Noto Sans KR', sans-serif;
                background-color: #f8fafc;
                /* bg-slate-50 */
                color: #1e293b;
                /* text-slate-800 */
            }

            .app-container {
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .section-card {
                background-color: white;
                padding: 1rem;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            }
        </style>
</head>

<body>

    <div class="app-container">

        <header class="flex justify-between items-center px-4 py-4 flex-shrink-0 bg-white shadow-sm">
            <a href="/Timetable" class="p-2 rounded-full hover:bg-slate-200 transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6" />
                </svg>
            </a>
            <h1 class="text-xl font-bold text-slate-800 flex-grow text-center pr-12">수업 수정</h1>
        </header>

        <main class="flex-grow px-4 py-4 overflow-y-auto pb-20">

            <form class="section-card p-6" method="post" action="/AddClass">

                <h2 class="text-xl font-bold mb-5">수업 정보</h2>

                <div class="space-y-4 mb-6">
                    <input type="text" name="title" placeholder="과목 이름 (예: 운영체제)" required
                        class="w-full p-3 border rounded-lg bg-slate-50 focus:border-sub-blue focus:ring-1 focus:ring-sub-blue transition">

                    <div class="flex space-x-3">
                        <input type="number" placeholder="학점 (예: 3)" min="1" max="5"
                            class="w-1/2 p-3 border rounded-lg bg-white focus:border-sub-blue focus:ring-1 focus:ring-sub-blue transition">
                        <input type="text" placeholder="담당 교수"
                            class="w-1/2 p-3 border rounded-lg bg-white focus:border-sub-blue focus:ring-1 focus:ring-sub-blue transition">
                    </div>
                </div>

                <h3 class="text-lg font-bold mb-3 border-t pt-4">수업 시간 설정</h3>

                <div id="time-slot-container" class="space-y-3">
                    <div class="flex flex-wrap items-center gap-2 border p-3 rounded-lg bg-white">
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <select name="day" class="p-2 border rounded text-sm bg-slate-50">
                                <option value="월">월</option>
                                <option value="화">화</option>
                                <option value="수">수</option>
                                <option value="목">목</option>
                                <option value="금">금</option>
                            </select>
                            <input type="time" name="start_time" value="09:00"
                                class="p-2 border rounded text-sm bg-slate-50">
                            <span>~</span>
                            <input type="time" name="end_time" value="10:00"
                                class="p-2 border rounded text-sm bg-slate-50">
                        </div>
                        <input type="text" name="place" placeholder="장소 (예: 공학관 101호)"
                            class="flex-grow min-w-[200px] p-2 border rounded text-sm bg-slate-50">
                        <button type="button" class="text-red-500 hover:text-red-700 p-1 remove-slot-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="button" id="add-slot-btn"
                    class="w-full mt-4 p-3 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:bg-slate-50 transition">
                    + 시간 추가
                </button>

                <h3 class="text-lg font-bold mb-3 border-t pt-4 mt-6">표시 설정</h3>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="text-slate-700 block mb-2">과목 색상</label>
                        <input type="hidden" name="class_color" id="class_color" value="bg-blue-100">
                        <div id="colorPalette" class="flex gap-2">
                            <button type="button" data-color="bg-blue-100"
                                class="w-8 h-8 rounded border-2 border-sub-blue bg-blue-100"></button>
                            <button type="button" data-color="bg-red-100"
                                class="w-8 h-8 rounded border bg-red-100"></button>
                            <button type="button" data-color="bg-green-100"
                                class="w-8 h-8 rounded border bg-green-100"></button>
                            <button type="button" data-color="bg-yellow-100"
                                class="w-8 h-8 rounded border bg-yellow-100"></button>
                            <button type="button" data-color="bg-purple-100"
                                class="w-8 h-8 rounded border bg-purple-100"></button>
                            <button type="button" data-color="bg-pink-100"
                                class="w-8 h-8 rounded border bg-pink-100"></button>
                        </div>
                    </div>
                    <textarea placeholder="선택 사항: 수업 관련 메모나 특이사항 (저장은 아직 미지원)" rows="3"
                        class="w-full p-3 border rounded-lg bg-slate-50 focus:border-sub-blue focus:ring-1 focus:ring-sub-blue transition"></textarea>
                </div>

                <button type="submit"
                    class="w-full bg-main-red text-white p-3 rounded-lg font-bold text-lg hover:bg-red-700 transition shadow-lg">
                    시간표 수정하기
                </button>
            </form>

        </main>

        <nav class="flex-shrink-0 fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.05)] pt-1">
            <div class="flex justify-around h-16 items-start">
                <a href="/Main"
                    class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span class="text-xs mt-1">홈</span>
                </a>
                <a href="/Calendar"
                    class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
                        <line x1="16" x2="16" y1="2" y2="6"></line>
                        <line x1="8" x2="8" y1="2" y2="6"></line>
                        <line x1="3" x2="21" y1="10" y2="10"></line>
                    </svg>
                    <span class="text-xs mt-1">캘린더</span>
                </a>
                <a href="/AnnouncementGuest"
                    class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M8 6h13"></path>
                        <path d="M8 12h13"></path>
                        <path d="M8 18h13"></path>
                        <path d="M3 6h.01"></path>
                        <path d="M3 12h.01"></path>
                        <path d="M3 18h.01"></path>
                    </svg>
                    <span class="text-xs mt-1">공지사항</span>
                </a>
                <a href="/Timetable" class="flex flex-col items-center justify-center text-main-red font-bold p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="7" height="9" x="3" y="3" rx="1"></rect>
                        <rect width="7" height="5" x="14" y="3" rx="1"></rect>
                        <rect width="7" height="9" x="14" y="12" rx="1"></rect>
                        <rect width="7" height="5" x="3" y="16" rx="1"></rect>
                    </svg>
                    <span class="text-xs mt-1">시간표</span>
                </a>
                <a href="/MyPage"
                    class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span class="text-xs mt-1">마이페이지</span>
                </a>
            </div>
        </nav>
    </div>

    <script>
        // 시간 추가/삭제 및 색상 선택 로직 AddClass.html랑 동일하게 일단..
        const container = document.getElementById('time-slot-container');
        const addBtn = document.getElementById('add-slot-btn');
        const colorPalette = document.getElementById('colorPalette');
        const colorHidden = document.getElementById('class_color');
        const form = document.getElementById('modify-form');

        const slotTemplate = `
        <div class="flex flex-wrap items-center gap-2 border p-3 rounded-lg bg-white">
            <div class="flex items-center gap-2 flex-shrink-0">
                <select name="day" class="p-2 border rounded text-sm bg-slate-50">
                    <option value="월">월</option><option value="화">화</option><option value="수">수</option><option value="목">목</option><option value="금">금</option>
                </select>
                <input type="time" name="start_time" value="09:00" class="p-2 border rounded text-sm bg-slate-50">
                <span>~</span>
                <input type="time" name="end_time" value="10:00" class="p-2 border rounded text-sm bg-slate-50">
            </div>
            <input type="text" name="place" placeholder="장소 (예: 공학관 101호)" class="flex-grow min-w-[200px] p-2 border rounded text-sm bg-slate-50">
            <button type="button" class="text-red-500 hover:text-red-700 p-1 remove-slot-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    `;

        // 새 슬롯 추가 함수
        function addNewSlot(slotData = {}) {
            const newSlot = document.createElement('div');
            newSlot.innerHTML = slotTemplate;
            const slotEl = newSlot.firstElementChild;

            // 백엔드 데이터로 값 채우기
            if (slotData.day) slotEl.querySelector('select[name="day"]').value = slotData.day;
            if (slotData.startTime) slotEl.querySelector('input[name="start_time"]').value = slotData.startTime;
            if (slotData.endTime) slotEl.querySelector('input[name="end_time"]').value = slotData.endTime;
            if (slotData.place) slotEl.querySelector('input[name="place"]').value = slotData.place;

            container.appendChild(slotEl);
        }

        addBtn.addEventListener('click', () => addNewSlot());

        container.addEventListener('click', (e) => {
            if (e.target.closest('.remove-slot-btn')) {
                if (container.children.length > 1) {
                    e.target.closest('.flex').remove();
                } else {
                    alert('최소한 하나의 수업 시간은 입력해야 합니다.');
                }
            }
        });

        colorPalette.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-color]');
            if (!btn) return;
            const color = btn.getAttribute('data-color');
            colorHidden.value = color;
            updateColorSelection();
        });

        function updateColorSelection() {
            const selectedColor = colorHidden.value;
            Array.from(colorPalette.querySelectorAll('button[data-color]')).forEach(b => {
                b.classList.remove('border-2', 'border-sub-blue');
                b.classList.add('border');
                if (b.getAttribute('data-color') === selectedColor) {
                    b.classList.remove('border');
                    b.classList.add('border-2', 'border-sub-blue');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const params = new URLSearchParams(window.location.search);
            const classId = params.get('classId') || params.get('id');

            document.getElementById('cancel-btn').href = `/ViewClass/${classId}`;

            if (!classId) {
                alert('수정할 수업 ID가 없습니다.');
                window.location.href = '/Timetable';
                return;
            }

            try {
                // 백엔드 API에서 기존 수업 정보 GET 하기
                const response = await fetch(`/api/classes/${classId}`);
                if (!response.ok) throw new Error('데이터 로딩 실패');

                const data = await response.json();

                // 폼에 데이터 채우기
                document.getElementById('title').value = data.title || '';
                document.getElementById('credits').value = data.credits || '';
                document.getElementById('professor').value = data.professor || '';
                colorHidden.value = data.color || 'bg-blue-100';
                updateColorSelection();

                // 기존 시간표 슬롯 채우기
                container.innerHTML = '';   // 기존 템플릿 비우기
                if (data.slots && data.slots.length > 0) {
                    data.slots.forEach(slot => addNewSlot(slot));
                } else {
                    addNewSlot();   // 빈 슬롯 1개 추가
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                alert('수업 정보를 불러오는 데 실패했습니다.');
            }
        });

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const params = new URLSearchParams(window.location.search);
            const classId = params.get('classId');

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const slots = [];
            container.querySelectorAll('.flex.flex-wrap.items-center').forEach(slotDiv => {
                const day = slotDiv.querySelector('select[name="day"]').value;
                const startTime = slotDiv.querySelector('input[name="start_time"]').value;
                const endTime = slotDiv.querySelector('input[name="end_time"]').value;
                const place = slotDiv.querySelector('input[name="place"]').value;
                slots.push({ day, startTime, endTime, place });
            });
            data.slots = slots;

            try {
                const response = await fetch(`/api/classes/${classId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('수정 실패');

                // 성공 시 다시 상세 페이지로 이동
                alert('수업 정보가 성공적으로 수정되었습니다.');
                window.location.href = `/ViewClass/${classId}`;

            } catch (error) {
                console.error('Error updating data:', error);
                alert('수정 중 오류가 발생했습니다.');
            }
        });
    </script>
</body>
</html>