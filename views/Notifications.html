<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>키우미 | 알림 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind configuration and custom colors maintained
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-red': '#ed2024',
                        'sub-blue': '#003875',
                    }
                }
            }
        }
    </script>
    <style>
        /* 알림창 배경 및 전체 레이아웃 (모달처럼 보이도록) */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
            /* bg-slate-50 */
            color: #1e293b;
            /* text-slate-800 */
        }

        .notification-modal {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f8fafc;
        }

        .notification-item {
            background-color: white;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            /* border-slate-100 */
            transition: background-color 0.15s;
        }

        .notification-item:hover {
            background-color: #f1f5f9;
            /* bg-slate-100 */
        }
    </style>
</head>

<body>

    <div class="notification-modal w-full">

        <header
            class="flex justify-between items-center px-4 py-4 flex-shrink-0 bg-white shadow-sm border-b border-slate-100">
            <button onclick="goBack()" class="p-2 rounded-full hover:bg-slate-200 transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5" />
                    <path d="m12 5-7 7 7 7" />
                </svg>
            </button>

            <h1 class="text-xl font-bold text-slate-800">알림 목록</h1>

            <div class="relative">
                <button id="menu-toggle" class="p-2 rounded-full hover:bg-slate-200 transition-colors text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>

                <div id="dropdown-menu"
                    class="hidden absolute right-0 top-full mt-2 w-40 bg-white rounded-md shadow-lg border z-10">
                    <button id="read-all-btn"
                        class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">
                        전체 읽음 처리
                    </button>
                    <button id="delete-all-btn"
                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                        전체 삭제
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto">

            <ul id="notification-list" class="divide-y divide-slate-100">
                <li class="text-center py-8 text-slate-400">알림을 불러오는 중...</li>
            </ul>

        </main>
    </div>

    <script>
        function goBack() {
            // 브라우저 히스토리가 있으면 이전 페이지로, 없으면 메인으로
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/Main';
            }
        }

        // 시간 포맷 함수
        function formatTime(createdAt) {
            const now = new Date();
            const created = new Date(createdAt);
            const diff = Math.floor((now - created) / 1000); // 초 단위

            if (diff < 60) return '방금 전';
            if (diff < 3600) return `${Math.floor(diff / 60)}분 전`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}시간 전`;
            if (diff < 172800) return '어제';

            // 그 이상은 날짜 표시
            return created.toLocaleDateString('ko-KR');
        }

        // 알림 목록 불러오기
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const data = await response.json();

                const listEl = document.getElementById('notification-list');

                if (!data.ok || data.notifications.length === 0) {
                    listEl.innerHTML = '<li class="text-center py-8 text-slate-400">알림이 없습니다.</li>';
                    return;
                }

                listEl.innerHTML = '';

                data.notifications.forEach(notif => {
                    const li = document.createElement('li');
                    li.className = `notification-item flex items-start space-x-3 cursor-pointer ${notif.is_read ? '' : 'bg-red-50'}`;
                    li.dataset.id = notif.id;
                    li.dataset.url = notif.link_url || '';

                    const iconColor = notif.is_read ? 'bg-slate-300' : 'bg-main-red';
                    const textOpacity = notif.is_read ? 'opacity-80' : '';

                    li.innerHTML = `
                        <div class="w-2 h-2 mt-1 ${iconColor} rounded-full flex-shrink-0"></div>
                        <div class="flex-grow ${textOpacity}">
                            <p class="font-semibold text-sm text-slate-800">${notif.title}</p>
                            <p class="text-xs text-slate-600 mt-1">${notif.message}</p>
                            <span class="text-[10px] text-slate-400 block mt-1 text-right">${formatTime(notif.created_at)}</span>
                        </div>
                    `;

                    // 클릭 이벤트
                    li.addEventListener('click', async () => {
                        // 읽음 처리
                        if (!notif.is_read) {
                            try {
                                await fetch(`/api/notifications/${notif.id}/read`, { method: 'PUT' });
                            } catch (e) {
                                console.error('읽음 처리 실패:', e);
                            }
                        }

                        // 링크 이동
                        if (notif.link_url) {
                            window.location.href = notif.link_url;
                        }
                    });

                    listEl.appendChild(li);
                });

                // 하단 여백
                const spacer = document.createElement('div');
                spacer.className = 'h-10';
                listEl.appendChild(spacer);

            } catch (error) {
                console.error('알림 불러오기 오류:', error);
                const listEl = document.getElementById('notification-list');
                listEl.innerHTML = '<li class="text-center py-8 text-red-500">알림을 불러오는데 실패했습니다.</li>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadNotifications();
            // 15초마다 알림 목록 자동 새로고침
            setInterval(loadNotifications, 15000);

            // 드롭다운 메뉴 이벤트 리스너
            const menuToggle = document.getElementById('menu-toggle');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const readAllBtn = document.getElementById('read-all-btn');
            const deleteAllBtn = document.getElementById('delete-all-btn');

            if (menuToggle && dropdownMenu) {
                menuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('hidden');
                });

                // 전체 읽음 처리
                readAllBtn.addEventListener('click', async () => {
                    dropdownMenu.classList.add('hidden');
                    if (confirm('모든 알림을 읽음 처리하시겠습니까?')) {
                        try {
                            // (백엔드) /api/notifications/read-all API 호출 (PUT)
                            const response = await fetch('/api/notifications/read-all', { method: 'PUT' });
                            if (!response.ok) throw new Error('읽음 처리 실패');

                            alert('모든 알림을 읽음 처리했습니다.');
                            loadNotifications();
                        } catch (err) {
                            alert('작업 중 오류가 발생했습니다.');
                        }
                    }
                });

                // 전체 삭제
                deleteAllBtn.addEventListener('click', async () => {
                    dropdownMenu.classList.add('hidden'); // 메뉴 닫기
                    if (confirm('모든 알림을 삭제합니다. 정말 삭제하시겠습니까?')) {
                        try {
                            // (백엔드) /api/notifications/delete-all API 호출 (DELETE)
                            const response = await fetch('/api/notifications/delete-all', { method: 'DELETE' });
                            if (!response.ok) throw new Error('삭제 실패');

                            alert('모든 알림이 삭제되었습니다.');
                            loadNotifications();
                        } catch (err) {
                            alert('작업 중 오류가 발생했습니다.');
                        }
                    }
                });

                // 화면 아무 곳이나 클릭하면 메뉴 닫기
                document.addEventListener('click', (e) => {
                    if (!dropdownMenu.classList.contains('hidden') && !e.target.closest('#menu-toggle')) {
                        dropdownMenu.classList.add('hidden');
                    }
                });
            }
        });
    </script>
</body>

</html>
