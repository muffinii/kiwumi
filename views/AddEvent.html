<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키우미 | 일정 추가</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind configuration and custom colors maintained
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-red': '#ed2024',
                        'sub-blue': '#003875',
                    }
                }
            }
        }
    </script>
    <style>
        /* 기존 디자인 스타일 유지 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .section-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* 관리자 탭 스타일 */
        .event-tab {
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #64748b;
            /* text-slate-500 */
            border-bottom: 3px solid transparent;
            transform: translateY(1px);
            /* 하단 경계선과 정렬 */
            cursor: pointer;
        }

        .event-tab.active-tab {
            color: #003875;
            /* sub-blue */
            border-bottom-color: #003875;
        }

        .alarm-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff;
            /* indigo-100 */
            color: #3730a3;
            /* indigo-800 */
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            /* rounded-full */
        }

        .alarm-tag button {
            margin-left: 0.5rem;
            color: #4338ca;
            /* indigo-700 */
            padding: 0.25rem;
            border-radius: 9999px;
        }

        .alarm-tag button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .alarm-option {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .alarm-option:hover {
            background-color: #f1f5f9;
            /* slate-100 */
        }

        .alarm-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: transparent;
        }
    </style>
</head>

<body>

    <div class="app-container">

        <header class="flex justify-between items-center px-4 py-4 flex-shrink-0 bg-white shadow-sm">
            <div class="flex items-center space-x-2">
                <button type="button" id="back-button" aria-label="뒤로가기"
                    class="p-2 rounded-full hover:bg-slate-200 transition-colors" onclick="history.back()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-slate-800">일정 추가</h1>
            </div>
            <a href="/Notifications"
                class="relative p-2 rounded-full hover:bg-slate-200 transition-colors inline-block">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="text-slate-600">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span class="absolute top-2 right-2 block w-2 h-2 bg-main-red rounded-full"></span>
            </a>
        </header>

        <main class="flex-grow px-4 py-4 overflow-y-auto pb-20">
            <div id="add-event-section" class="section-card p-4 rounded-lg shadow-md mb-8 h-full min-h-[600px]">

                {% if user_role == 'admin' %}
                <div class="border-b border-slate-200 mb-4">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button id="tab-public" type="button" class="event-tab active-tab">
                            학사 일정
                        </button>
                        <button id="tab-private" type="button" class="event-tab">
                            개인 일정
                        </button>
                    </nav>
                </div>
                <p id="personal-desc" class="text-slate-600 mb-4 text-sm sm:text-base hidden">
                    개인적인 스케줄을 달력에 등록하고 관리하세요.
                </p>
                {% else %}
                <h3 class="text-lg font-bold mb-3">새로운 개인 일정</h3>
                <p class="text-slate-600 mb-4 text-sm sm:text-base">개인적인 스케줄을 달력에 등록하고 관리하세요.</p>
                {% endif %}

                <div class="bg-slate-100 p-3 rounded-lg flex flex-col h-full">
                    <form id="add-event-form" method="post" action="/AddEvent"
                        class="flex flex-col h-full p-2 space-y-4">

                        <input type="hidden" id="event-type" name="event_type"
                            value="{% if user_role == 'admin' %}public{% else %}private{% endif %}">

                        <div>
                            <label for="event-title" class="block text-sm font-medium text-slate-700">일정명</label>
                            <input type="text" id="event-title" name="title" placeholder="예: 팀 프로젝트 회의"
                                class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                        </div>

                        <div id="public-fields"
                            class="grid grid-cols-2 gap-4 {% if user_role == 'admin' %}{% else %}hidden{% endif %}">
                            <div>
                                <label for="start-date" class="block text-sm font-medium text-slate-700">시작일</label>
                                <input type="date" id="start-date" name="start_date"
                                    class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-medium text-slate-700">종료일</label>
                                <input type="date" id="end-date" name="end_date"
                                    class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                            </div>
                        </div>

                        <div id="personal-fields" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="event-date" class="block text-sm font-medium text-slate-700">날짜</label>
                                    <input type="date" id="event-date" name="event_date"
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="event-time" class="block text-sm font-medium text-slate-700">시간
                                        (선택)</label>
                                    <input type="time" id="event-time" name="event_time"
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">배경색</label>
                                <div id="event-color-options" class="mt-2 flex space-x-3">

                                    <div data-color="bg-red-200"
                                        class="event-color-option w-8 h-8 rounded-full bg-red-200 cursor-pointer ring-2 ring-offset-2 ring-sub-blue"
                                        title="빨강"></div>

                                    <div data-color="bg-blue-200"
                                        class="event-color-option w-8 h-8 rounded-full bg-blue-200 cursor-pointer"
                                        title="파랑"></div>

                                    <div data-color="bg-yellow-200"
                                        class="event-color-option w-8 h-8 rounded-full bg-yellow-200 cursor-pointer"
                                        title="노랑"></div>

                                </div>
                                <input type="hidden" name="event_color" id="event-color" value="bg-red-200" />
                            </div>
                            <div>
                                <label for="event-memo" class="block text-sm font-medium text-slate-700">메모 (선택)</label>
                                <textarea id="event-memo" name="memo" rows="3" placeholder="메모를 입력하세요"
                                    class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm"></textarea>
                            </div>
                        </div>

                        <div id="alarm-section" class="border-t border-slate-200 pt-4 space-y-3">
                            <label class="text-sm font-medium text-slate-700">알림 설정</label>

                            <div id="alarm-list-container" class="flex flex-wrap gap-2">
                                <p class="text-xs text-slate-400">설정된 알림이 없습니다.</p>
                            </div>

                            <div class="relative">
                                <button type="button" id="add-alarm-toggle"
                                    class="w-full text-sm font-medium text-sub-blue p-2 rounded-lg hover:bg-slate-200 transition border-2 border-dashed border-slate-300">
                                    + 알림 추가
                                </button>

                                <div id="add-alarm-options"
                                    class="hidden absolute left-0 right-0 bottom-full mb-1 p-2 bg-white shadow-lg rounded-lg border z-10 space-y-1">
                                    <button type="button" data-alarm="10m" data-text="10분 전" class="alarm-option">10분
                                        전</button>
                                    <button type="button" data-alarm="30m" data-text="30분 전" class="alarm-option">30분
                                        전</button>
                                    <button type="button" data-alarm="1h" data-text="1시간 전" class="alarm-option">1시간
                                        전</button>
                                    <button type="button" data-alarm="12h" data-text="12시간 전" class="alarm-option">12시간
                                        전</button>
                                    <button type="button" data-alarm="1d" data-text="1일 전" class="alarm-option">1일
                                        전</button>
                                    <button type="button" data-alarm="1w" data-text="1주일 전" class="alarm-option">1주일
                                        전</button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-auto pt-4">
                            <button type="submit" id="submit-button"
                                class="w-full bg-main-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors">추가하기</button>
                            <p id="add-event-confirm" class="text-center text-green-600 font-semibold h-6 mt-2"></p>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            function showConfirmation(elementId, message) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.textContent = message;
                    setTimeout(() => {
                        el.textContent = '';
                    }, 3000);
                }
            }

            const addEventForm = document.getElementById('add-event-form');
            const eventColorOptions = document.getElementById('event-color-options');
            const eventColorHidden = document.getElementById('event-color');

            const tabPublic = document.getElementById('tab-public');
            const tabPrivate = document.getElementById('tab-private');
            const personalDesc = document.getElementById('personal-desc');
            const eventTypeInput = document.getElementById('event-type');
            const submitButton = document.getElementById('submit-button');
            const publicFields = document.getElementById('public-fields');
            const personalFields = document.getElementById('personal-fields');

            const alarmSection = document.getElementById('alarm-section');
            const alarmListContainer = document.getElementById('alarm-list-container');
            const addAlarmToggle = document.getElementById('add-alarm-toggle');
            const addAlarmOptions = document.getElementById('add-alarm-options');
            let currentAlarms = [];

            // 초기 상태 설정: 관리자의 경우 학사일정(public)이 기본이므로 알림 섹션 숨김
            if (eventTypeInput && eventTypeInput.value === 'public') {
                if (alarmSection) alarmSection.classList.add('hidden');
            }

            if (tabPublic && tabPrivate) {

                tabPublic.addEventListener('click', () => {
                    tabPublic.classList.add('active-tab');
                    tabPrivate.classList.remove('active-tab');
                    eventTypeInput.value = 'public';
                    if (personalDesc) personalDesc.classList.add('hidden');
                    submitButton.classList.add('bg-main-red', 'hover:bg-red-700');
                    submitButton.classList.remove('bg-sub-blue', 'hover:bg-blue-800');
                    if (publicFields) publicFields.classList.remove('hidden');
                    if (personalFields) personalFields.classList.add('hidden');
                    if (alarmSection) alarmSection.classList.add('hidden');  // 학사일정은 알림 불가
                });

                tabPrivate.addEventListener('click', () => {
                    tabPrivate.classList.add('active-tab');
                    tabPublic.classList.remove('active-tab');
                    eventTypeInput.value = 'private';
                    if (personalDesc) personalDesc.classList.remove('hidden');
                    submitButton.classList.add('bg-sub-blue', 'hover:bg-blue-800');
                    submitButton.classList.remove('bg-main-red', 'hover:bg-red-700');
                    if (publicFields) publicFields.classList.add('hidden');
                    if (personalFields) personalFields.classList.remove('hidden');
                    if (alarmSection) alarmSection.classList.remove('hidden');  // 개인일정은 알림 가능
                });
            }

            // 알림 렌더링 함수
            function renderAlarms() {
                alarmListContainer.innerHTML = '';

                if (currentAlarms.length === 0) {
                    alarmListContainer.innerHTML = '<p class="text-xs text-slate-400">설정된 알림이 없습니다.</p>';
                } else {
                    currentAlarms.forEach(alarmOffset => {
                        const option = addAlarmOptions.querySelector(`[data-alarm="${alarmOffset}"]`);
                        const text = option ? option.dataset.text : alarmOffset;    // 10분 전

                        const tag = document.createElement('span');
                        tag.className = 'alarm-tag';
                        tag.innerHTML = `
                            ${text}
                            <button type="button" class="remove-alarm-btn" data-alarm="${alarmOffset}" aria-label="알림 삭제">
                                &times;
                            </button>
                        `;
                        alarmListContainer.appendChild(tag);
                    });
                }

                // 알림 추가 옵션에서 이미 선택된 항목은 비활성화
                document.querySelectorAll('.alarm-option').forEach(option => {
                    const offset = option.dataset.alarm;
                    if (currentAlarms.includes(offset)) {
                        option.classList.add('disabled');
                        option.disabled = true;
                    } else {
                        option.classList.remove('disabled');
                        option.disabled = false;
                    }
                });
            }

            // 알림 추가/삭제 이벤트 리스너
            addAlarmToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                addAlarmOptions.classList.toggle('hidden');
            });

            // 알림 옵션(10분 전 등) 클릭 시 (배열에만 추가)
            addAlarmOptions.addEventListener('click', (e) => {
                const button = e.target.closest('.alarm-option');
                if (!button || button.disabled) return;

                const alarmOffset = button.dataset.alarm;
                addAlarmOptions.classList.add('hidden');

                if (!currentAlarms.includes(alarmOffset)) {
                    currentAlarms.push(alarmOffset);
                    renderAlarms();
                }
            });

            // 알림 태그의 'x' 버튼 클릭 시 (배열에서 제거)
            alarmListContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.remove-alarm-btn');
                if (!button) return;

                const alarmOffset = button.dataset.alarm;
                currentAlarms = currentAlarms.filter(a => a !== alarmOffset);
                renderAlarms();
            });

            // 화면 아무 곳이나 클릭하면 알림 옵션 닫기
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#add-alarm-toggle') && !e.target.closest('#add-alarm-options')) {
                    addAlarmOptions.classList.add('hidden');
                }
            });

            if (eventTypeInput && eventTypeInput.value === 'public') {
                if (publicFields) publicFields.classList.remove('hidden');
                if (personalFields) personalFields.classList.add('hidden');
            } else {
                if (publicFields) publicFields.classList.add('hidden');
                if (personalFields) personalFields.classList.remove('hidden');
            }

            if (eventColorOptions) {
                eventColorOptions.addEventListener('click', (e) => {
                    if (e.target.classList.contains('event-color-option')) {
                        eventColorOptions.querySelectorAll('.event-color-option').forEach(opt => {
                            opt.classList.remove('ring-2', 'ring-offset-2', 'ring-sub-blue');
                        });
                        e.target.classList.add('ring-2', 'ring-offset-2', 'ring-sub-blue');
                        if (eventColorHidden) eventColorHidden.value = e.target.dataset.color || 'bg-red-200';
                    }
                });
            }

            // 알림 목록 전송 추가
            if (addEventForm) {
                addEventForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const selectedColorEl = eventColorOptions.querySelector('.ring-sub-blue');
                    const titleInput = document.getElementById('event-title');
                    const dateInput = document.getElementById('event-date');
                    const timeInput = document.getElementById('event-time');
                    const memoInput = document.getElementById('event-memo');
                    const startInput = document.getElementById('start-date');
                    const endInput = document.getElementById('end-date');

                    const params = new URLSearchParams();
                    params.set('title', titleInput.value);
                    params.set('event_type', eventTypeInput.value);

                    // 알림 목록을 JSON 문자열로 변환하여 추가
                    params.set('alarms', JSON.stringify(currentAlarms));

                    if (eventTypeInput.value === 'public') {
                        if (!titleInput.value || !startInput.value || !endInput.value) {
                            alert('제목과 시작일/종료일은 필수입니다!');
                            return;
                        }
                        if (new Date(startInput.value) > new Date(endInput.value)) {
                            alert('종료일은 시작일보다 빠를 수 없습니다.');
                            return;
                        }
                        params.set('start_date', startInput.value);
                        params.set('end_date', endInput.value);
                    } else {
                        if (!titleInput.value || !dateInput.value || !selectedColorEl) {
                            alert('제목, 날짜, 색상은 필수입니다!');
                            return;
                        }
                        params.set('event_date', dateInput.value);
                        params.set('event_time', timeInput.value || '');
                        if (memoInput && memoInput.value) params.set('memo', memoInput.value);
                        params.set('event_color', selectedColorEl.dataset.color || 'bg-red-200');
                    }

                    let fetchURL = '/AddEvent';

                    try {
                        const resp = await fetch(fetchURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
                            body: params.toString()
                        });
                        const data = await resp.json();

                        if (data && data.ok) {
                            alert('성공적으로 추가되었습니다!');
                            window.location.href = '/Calendar';
                            return;
                        } else {
                            alert(data && data.message ? data.message : '추가 실패');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('서버 오류');
                    }
                });
            }

            if (eventColorOptions && eventColorOptions.children.length > 0) {
                eventColorOptions.children[0].classList.add('ring-2', 'ring-offset-2', 'ring-sub-blue');
            }
        });
    </script>
</body>

</html>
