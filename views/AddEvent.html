<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키우미 | 일정 추가</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind configuration and custom colors maintained
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-red': '#ed2024',
                        'sub-blue': '#003875',
                    }
                }
            }
        }
    </script>
    <style>
        /* 기존 디자인 스타일 유지 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .section-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* ▼▼▼ [1. 신규 CSS] 관리자 탭 스타일 ▼▼▼ */
        .event-tab {
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #64748b; /* text-slate-500 */
            border-bottom: 3px solid transparent;
            transform: translateY(1px); /* 하단 경계선과 정렬 */
            cursor: pointer;
        }
        .event-tab.active-tab {
            color: #003875; /* sub-blue */
            border-bottom-color: #003875;
        }
        /* ▲▲▲ CSS 추가 완료 ▲▲▲ */
    </style>
</head>

<body>

    <div class="app-container">

        <header class="flex justify-between items-center px-4 py-4 flex-shrink-0 bg-white shadow-sm">
            <div class="flex items-center space-x-2">
                <button type="button" id="back-button" aria-label="뒤로가기"
                        class="p-2 rounded-full hover:bg-slate-200 transition-colors"
                        onclick="history.back()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-slate-800">일정 추가</h1>
            </div>
            <a href="/Notifications.html" class="relative p-2 rounded-full hover:bg-slate-200 transition-colors inline-block">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="text-slate-600">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span class="absolute top-2 right-2 block w-2 h-2 bg-main-red rounded-full"></span>
            </a>
        </header>

        <main class="flex-grow px-4 py-4 overflow-y-auto pb-20">
            <div id="add-event-section" class="section-card p-4 rounded-lg shadow-md mb-8 h-full min-h-[600px]">
                
                {% if user_role == 'admin' %}
                    <div class="border-b border-slate-200 mb-4">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button id="tab-public" type="button" class="event-tab active-tab">
                                학사 일정
                            </button>
                            <button id="tab-private" type="button" class="event-tab">
                                개인 일정
                            </button>
                        </nav>
                    </div>
                    <p id="personal-desc" class="text-slate-600 mb-4 text-sm sm:text-base hidden">
                        개인적인 스케줄을 달력에 등록하고 관리하세요.
                    </p>
                
                {% else %}
                    <h3 class="text-lg font-bold mb-3">새로운 개인 일정</h3>
                    <p class="text-slate-600 mb-4 text-sm sm:text-base">개인적인 스케줄을 달력에 등록하고 관리하세요.</p>
                
                {% endif %}
                <div class="bg-slate-100 p-3 rounded-lg flex flex-col h-[80%]">
                    <form id="add-event-form" method="post" action="/AddEvent" class="flex flex-col h-full p-2 space-y-4">
                        
                        <input type="hidden" id="event-type" name="event_type" 
                               value="{% if user_role == 'admin' %}public{% else %}private{% endif %}">
                        <div>
                            <label for="event-title" class="block text-sm font-medium text-slate-700">일정명</label>
                            <input type="text" id="event-title" name="title" placeholder="예: 팀 프로젝트 회의"
                                class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                        </div>

                        <!-- 학사 일정 전용 필드: 시작일/종료일 -->
                        <div id="public-fields" class="grid grid-cols-2 gap-4 {% if user_role == 'admin' %}{% else %}hidden{% endif %}">
                            <div>
                                <label for="start-date" class="block text-sm font-medium text-slate-700">시작일</label>
                                <input type="date" id="start-date" name="start_date"
                                    class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-medium text-slate-700">종료일</label>
                                <input type="date" id="end-date" name="end_date"
                                    class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                            </div>
                        </div>

                        <!-- 개인 일정 전용 필드: 날짜/시간/색상 -->
                        <div id="personal-fields" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="event-date" class="block text-sm font-medium text-slate-700">날짜</label>
                                    <input type="date" id="event-date" name="event_date"
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="event-time" class="block text-sm font-medium text-slate-700">시간 (선택)</label>
                                    <input type="time" id="event-time" name="event_time"
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">배경색</label>
                                <div id="event-color-options" class="mt-2 flex space-x-3">
                                    <div data-color="bg-red-200"
                                        class="event-color-option w-8 h-8 rounded-full bg-red-200 cursor-pointer ring-2 ring-offset-2 ring-sub-blue"
                                        title="빨강"></div>
                                    <div data-color="bg-blue-200"
                                        class="event-color-option w-8 h-8 rounded-full bg-blue-200 cursor-pointer"
                                        title="파랑"></div>
                                    <div data-color="bg-green-200"
                                        class="event-color-option w-8 h-8 rounded-full bg-green-200 cursor-pointer"
                                        title="초록"></div>
                                    <div data-color="bg-yellow-200"
                                        class="event-color-option w-8 h-8 rounded-full bg-yellow-200 cursor-pointer"
                                        title="노랑"></div>
                                </div>
                                <input type="hidden" name="event_color" id="event-color" value="bg-red-200" />
                            </div>
                        </div>
                        <div class="mt-auto pt-4">
                            <button type="submit" id="submit-button"
                                class="w-full bg-main-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors">추가하기</button>
                            <p id="add-event-confirm" class="text-center text-green-600 font-semibold h-6 mt-2"></p>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <nav class="flex-shrink-0 sticky bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.05)] pt-1">
            <div class="flex justify-around h-16 items-start">
                    <a href="/Main"
                    class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg ...></svg>
                    <span class="text-xs mt-1">홈</span>
                </a>
                <a href="/Calendar" class="flex flex-col items-center justify-center text-main-red font-bold p-1">
                    <svg ...></svg>
                    <span class="text-xs mt-1">캘린더</span>
                </a>
                <a href="/AnnouncementGuest"
                    class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg ...></svg>
                    <span class="text-xs mt-1">공지사항</span>
                </a>
                {% if user_role == 'student' %}
                    <a href="/Timetable"
                        class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                        <svg ...></svg>
                        <span class="text-xs mt-1">시간표</span>
                    </a>
                {% endif %}
                <a href="/MyPage"
                    class="flex flex-col items-center justify-center text-slate-500 hover:text-sub-blue p-1">
                    <svg ...></svg>
                    <span class="text-xs mt-1">마이</span>
                </a>
            </div>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            function showConfirmation(elementId, message) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.textContent = message;
                    setTimeout(() => {
                        el.textContent = '';
                    }, 3000);
                }
            }

            // --- 폼 요소 ---
            const addEventForm = document.getElementById('add-event-form');
            const eventColorOptions = document.getElementById('event-color-options');
            const eventColorHidden = document.getElementById('event-color');
            
            // --- 신규 요소 (관리자 탭) ---
            const tabPublic = document.getElementById('tab-public');
            const tabPrivate = document.getElementById('tab-private');
            const personalDesc = document.getElementById('personal-desc');
            const eventTypeInput = document.getElementById('event-type');
            const submitButton = document.getElementById('submit-button');
            const publicFields = document.getElementById('public-fields');
            const personalFields = document.getElementById('personal-fields');

            if (tabPublic && tabPrivate) { // 관리자일 때만 실행
                
                tabPublic.addEventListener('click', () => {
                    tabPublic.classList.add('active-tab');
                    tabPrivate.classList.remove('active-tab');
                    
                    eventTypeInput.value = 'public';
                    
                    if (personalDesc) personalDesc.classList.add('hidden');
                    
                    submitButton.classList.add('bg-main-red', 'hover:bg-red-700');
                    submitButton.classList.remove('bg-sub-blue', 'hover:bg-blue-800');

                    // 필드 표시 전환
                    if (publicFields) publicFields.classList.remove('hidden');
                    if (personalFields) personalFields.classList.add('hidden');
                });

                tabPrivate.addEventListener('click', () => {
                    tabPrivate.classList.add('active-tab');
                    tabPublic.classList.remove('active-tab');

                    eventTypeInput.value = 'private';
                    
                    if (personalDesc) personalDesc.classList.remove('hidden');

                    submitButton.classList.add('bg-sub-blue', 'hover:bg-blue-800');
                    submitButton.classList.remove('bg-main-red', 'hover:bg-red-700');

                    // 필드 표시 전환
                    if (publicFields) publicFields.classList.add('hidden');
                    if (personalFields) personalFields.classList.remove('hidden');
                });
            }

            // 초기 필드 표시 상태
            if (eventTypeInput && eventTypeInput.value === 'public') {
                if (publicFields) publicFields.classList.remove('hidden');
                if (personalFields) personalFields.classList.add('hidden');
            } else {
                if (publicFields) publicFields.classList.add('hidden');
                if (personalFields) personalFields.classList.remove('hidden');
            }


            if (eventColorOptions) {
                eventColorOptions.addEventListener('click', (e) => {
                    if (e.target.classList.contains('event-color-option')) {
                        eventColorOptions.querySelectorAll('.event-color-option').forEach(opt => {
                            opt.classList.remove('ring-2', 'ring-offset-2', 'ring-sub-blue');
                        });
                        e.target.classList.add('ring-2', 'ring-offset-2', 'ring-sub-blue');
                        if (eventColorHidden) eventColorHidden.value = e.target.dataset.color || 'bg-red-200';
                    }
                });
            }

            if (addEventForm) {
                addEventForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const selectedColorEl = eventColorOptions.querySelector('.ring-sub-blue');
                    const titleInput = document.getElementById('event-title');
                    const dateInput = document.getElementById('event-date');
                    const timeInput = document.getElementById('event-time');
                    const startInput = document.getElementById('start-date');
                    const endInput = document.getElementById('end-date');

                    const params = new URLSearchParams();
                    params.set('title', titleInput.value);
                    params.set('event_type', eventTypeInput.value);

                    if (eventTypeInput.value === 'public') {
                        // 학사일정: 제목, 시작/종료일 필수
                        if (!titleInput.value || !startInput.value || !endInput.value) {
                            alert('제목과 시작일/종료일은 필수입니다!');
                            return;
                        }
                        // 날짜 유효성
                        if (new Date(startInput.value) > new Date(endInput.value)) {
                            alert('종료일은 시작일보다 빠를 수 없습니다.');
                            return;
                        }
                        params.set('start_date', startInput.value);
                        params.set('end_date', endInput.value);
                    } else {
                        // 개인일정: 제목, 날짜, 색상 필수
                        if (!titleInput.value || !dateInput.value || !selectedColorEl) {
                            alert('제목, 날짜, 색상은 필수입니다!');
                            return;
                        }
                        params.set('event_date', dateInput.value);
                        params.set('event_time', timeInput.value || '');
                        params.set('event_color', selectedColorEl.dataset.color || 'bg-red-200');
                    }
                    
                    let fetchURL = '/AddEvent'; // 기본 제출 URL
                    
                    // 만약 관리자면 URL을 바꿔야 한다면 여기서 분기
                    // if (eventTypeInput.value === 'public') {
                    //    fetchURL = '/AddPublicEvent';
                    // } else if (eventTypeInput.value === 'private') {
                    //    fetchURL = '/AddPrivateEvent';
                    // }

                    try {
                        const resp = await fetch(fetchURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
                            body: params.toString()
                        });
                        const data = await resp.json();
                        
                        if (data && data.ok) {
                            alert('성공적으로 추가되었습니다!');
                            addEventForm.reset();
                            // (색상 선택 초기화)
                            eventColorOptions.querySelectorAll('.event-color-option').forEach(opt => {
                                opt.classList.remove('ring-2', 'ring-offset-2', 'ring-sub-blue');
                            });
                            eventColorOptions.children[0].classList.add('ring-2', 'ring-offset-2', 'ring-sub-blue');
                            if (eventColorHidden) eventColorHidden.value = 'bg-red-200';
                            // (관리자 탭 초기화)
                            if(tabPublic) tabPublic.click();
                        } else {
                            alert(data && data.message ? data.message : '추가 실패');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('서버 오류');
                    }
                });
            }

            // --- Initial Color Selection ---
            if (eventColorOptions && eventColorOptions.children.length > 0) {
                eventColorOptions.children[0].classList.add('ring-2', 'ring-offset-2', 'ring-sub-blue');
            }
        });
    </script>
</body>

</html>
