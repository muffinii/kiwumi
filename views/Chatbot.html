<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>키우미 | 챗봇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind configuration and custom colors maintained
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-red': '#ed2024',
                        'sub-blue': '#003875', /* 사용자 말풍선 색상 */
                        'bg-light': '#f8fafc',
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%; 
            height: 100%; 
            overflow-x: hidden; 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
        }
        .app-container { 
            width: 100%;
            height: 100vh; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }
        .chat-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 1rem; 
            background-color: #f8fafc; /* bg-slate-50 */
        }
        /* 사용자 말풍선 (sub-blue) */
        .user-bubble {
            background-color: #003875; 
            color: white; 
            border-radius: 12px 12px 0 12px;
            padding: 0.75rem;
            max-width: 80%;
        }
        /* AI 말풍선 (흰색) */
        .ai-bubble {
            background-color: white;
            color: #1e293b; 
            border-radius: 12px 12px 12px 0;
            padding: 0.75rem;
            max-width: 80%;
        }
    </style>
</head>

<body>

    <div class="app-container">

        <header class="flex justify-between items-center px-4 py-4 flex-shrink-0 bg-white shadow-sm">
            <a href="/MyPage" class="p-2 rounded-full hover:bg-slate-200 transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </a>
            <h1 class="text-xl font-bold text-slate-800 flex-grow text-center">AI 챗봇 키우미</h1>
            <div class="w-10"></div> </header>

        <main id="chat-messages" class="chat-area">
            <div class="flex justify-start mb-4">
                <div class="flex flex-col gap-1">
                    <div class="ai-bubble">
                        <p class="text-sm font-normal">안녕하세요! 여러분의 학교생활 도우미 키우미예요!<br>학사 정보, 시설 안내 등 학교 생활에 대해 궁금한 점을 저에게 물어보세요.</p>
                    </div>
                </div>
            </div>
            
             </main>

        <div class="flex-shrink-0 p-3 bg-white border-t border-slate-200">
            <form id="chat-form" class="relative flex items-center">
                  <input type="text" id="chat-input" placeholder="메시지를 입력하세요..." autocomplete="off"
                      class="form-input w-full p-3 pr-12 text-sm border border-slate-300 rounded-full focus:ring-sub-blue focus:border-sub-blue">
                <button type="submit" id="send-button"
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full bg-sub-blue text-white hover:bg-blue-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>

    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');

            // 메시지 스크롤을 맨 아래로 이동
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // 텍스트를 HTML로 변환하는 함수 (줄바꿈, 링크 처리)
            function formatMessage(text) {
                // 1. 줄바꿈 처리 (\n을 <br>로)
                let formatted = text.replace(/\n/g, '<br>');
                
                // 2. URL을 클릭 가능한 링크로 변환
                const urlPattern = /(https?:\/\/[^\s]+)/g;
                formatted = formatted.replace(urlPattern, '<a href="$1" target="_blank" class="text-blue-500 hover:text-blue-700 underline">$1</a>');
                
                return formatted;
            }

            // 메시지를 채팅창에 추가하는 함수
            function appendMessage(sender, text, isFormatted = false) {
                const isUser = sender === 'user';
                const formattedText = isFormatted ? text : formatMessage(text);
                const messageHtml = `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'} mb-4">
                        <div class="${isUser ? 'user-bubble' : 'ai-bubble'}">
                            <p class="text-sm font-normal">${formattedText}</p>
                        </div>
                    </div>
                `;
                chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                scrollToBottom();
            }

            // 입력창 포커스 시 입력값이 남아있지 않도록
            chatInput.addEventListener('focus', function() {
                if (chatInput.value === chatInput.placeholder) {
                    chatInput.value = '';
                }
            });

            // 폼 제출 이벤트 (백엔드 통신)
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const userMessage = chatInput.value.trim();

                if (userMessage === '') return;

                // 1. 사용자 메시지 표시
                appendMessage('user', userMessage);
                chatInput.value = '';
                chatInput.blur(); // 입력 후 포커스 해제

                // 2. 로딩 상태 표시 (AI가 응답을 준비하는 것처럼)
                appendMessage('ai', '...');
                const loadingBubble = chatMessages.lastElementChild.querySelector('.ai-bubble');

                try {
                    // 3. 백엔드 API 호출 (POST)
                    const response = await fetch('/api/chatbot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: userMessage })
                    });
                    const data = await response.json();
                    let aiResponseText;
                    if (response.ok && data.answer) {
                        aiResponseText = data.answer;
                    } else if (response.status === 404) {
                        aiResponseText = "죄송해요, 해당 정보는 아직 학습되지 않았어요. 다른 질문으로 도와드릴까요?";
                    } else {
                        aiResponseText = "응답을 처리하는 중 오류가 발생했습니다.";
                    }
                    loadingBubble.innerHTML = `<p class="text-sm font-normal">${formatMessage(aiResponseText)}</p>`;
                } catch (error) {
                    console.error('Chatbot API error:', error);
                    loadingBubble.innerHTML = `<p class="text-sm font-normal text-main-red">서버 연결에 실패했습니다.</p>`;
                }
                scrollToBottom();
            });

            // 초기 로드 시 스크롤
            scrollToBottom();

            // 채팅 입력창 포커스 시 화면 하단으로 스크롤 (키보드 위에 입력창이 보이도록)
            chatInput.addEventListener('focus', function() {
                setTimeout(() => {
                    // 채팅 영역을 맨 아래로 스크롤
                    scrollToBottom();
                    // 입력창을 화면 하단으로 (키보드 바로 위로)
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                }, 300);
            });
        });
    </script>
</body>
</html>
